pipeline:
  build:
    image: hseeberger/scala-sbt
    commands:
      - sbt assembly
    when:
      event: push

  docker-build:
    privileged: true
    image: docker:1.13
    environment:
      - DOCKER_HOST=tcp://127.0.0.1:2375
    commands:
      - docker build -t mercury .
    when:
      event: push

  integration:
      privileged: true
      image: docker/compose:1.10.1
      environment:
        - DOCKER_HOST=tcp://127.0.0.1:2375
      commands:
        - docker-compose up -d
        - sleep 10
        - docker-compose exec -T mercury sbt it:test
        - docker-compose stop
        - sleep 30
        - docker-compose kill
      when:
        event: push

services:
  dind:
    image: docker:1.13-dind
    privileged: true
    command:
      - "-s"
      - "overlay"